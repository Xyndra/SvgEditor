<html>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://kit.fontawesome.com/ca6139f5ee.js" crossorigin="anonymous"></script>
    </head>
    <body style="margin: 0;">
        <svg id="svg" style="width:100vh; height:100vh;" viewBox="0 0 100 100"></svg>
        <div id="sidebar1">
            <div id="sidebar1header">
                <p><i class="fa-solid fa-grip-lines fa-xl"></i></p>
            </div>
            <p>
            <i class="fa-regular fa-circle fa-2xl selected_element" onclick="changeMode('circle')"></i>
            <br/>
            <br/>
            <br/>
            <i class="fa-regular fa-square fa-2xl" onclick="changeMode('square')"></i>
            </p>
            <br/>
        </div>
        <script>
            svg = d3.select("svg")
            objs = [
                {elem: "circle", attr: {"cx": "50", "cy": "50", "r": "20", "stroke": "green", "stroke-width": "4", "fill": "yellow"}},
            ]
            var mode = "circle";

            // Make the DIV element draggable:
            dragElement(document.getElementById("sidebar1"));

            function dragElement(elmnt) {
                var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // set the element's new position:
                    let rect = elmnt.getBoundingClientRect();
                    if(rect.top - pos2 > 0 && rect.bottom - pos2 < window.innerHeight) {
                        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    }
                    if(rect.left - pos1 > 0 && rect.right - pos1 < window.innerWidth) {
                        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                    }
                }

                function closeDragElement() {
                    // stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }

            function changeMode(newMode) {
                let current = document.getElementsByClassName("selected_element")[0];
                        current.classList.remove("selected_element");
                switch(newMode) {
                    case "circle":
                        let circle = document.getElementsByClassName("fa-circle")[0];
                        circle.classList.add("selected_element");
                        break;
                    case "square":
                        let square = document.getElementsByClassName("fa-square")[0];
                        square.classList.add("selected_element");
                        break;
                }
                mode = newMode;
            }

            function rerender() {
                svg.selectAll("*").remove();
                objs.forEach(element => {
                    obj = svg.append(element.elem);
                    for (const [key, value] of Object.entries(element.attr)) {
                        obj.attr(key, value);
                    }
                });
                svg.selectAll("*").each(function(d, i) { 
                    d3.select(this).on("contextmenu", function(event) {
                        var coords = d3.pointer(event);
                        var x = coords[0];
                        var y = coords[1];

                        var obj_index = null;
                        var loop_running = true;

                        objs.slice().reverse().forEach(element => {
                            if (loop_running) {
                                let dist = Math.hypot(Math.abs(parseInt(element.attr.cx)-x), Math.abs(parseInt(element.attr.cy)-y));
                                if (dist < parseInt(element.attr.r) + parseInt(element.attr["stroke-width"]) / 2) {
                                    obj_index = objs.findIndex(element2 => element2 === element);
                                    loop_running  = false;
                                }
                            }
                        });

                        if (obj_index != null) {
                            objs.splice(obj_index, 1)
                        }

                        rerender();
                        event.preventDefault();
                    })
                })
            }
            rerender();
            svg.on("click", function(event) {
                var coords = d3.pointer(event);
                var x = coords[0];
                var y = coords[1];
                
                switch(mode){
                    case "circle":
                        objs.push({elem: "circle", attr: {"cx": x.toString(), "cy": y.toString(), "r": "5", "stroke": "green", "stroke-width": "4", "fill": "blue"}})
                        break;
                    case "square":
                        objs.push({elem: "rect", attr: {"cx": x.toString(), "cy": y.toString(), "x": (x-5).toString(), "y": (y-5).toString(), "r": "5", "width": "10", "height": "10", "stroke": "green", "stroke-width": "1", "fill": "blue"}})
                        break;
                }
                
                rerender();
            })

        </script>
        <style>
            #svg {
                position: relative;
                margin-left:auto;
                margin-right:auto;
                display:block;
                background-color: #fff;
            }
            #sidebar1 {
                position: absolute;
                left: 0;
                top: 0;
                z-index: 9;
                background-color: MidnightBlue;
                border: 5px solid MidnightBlue;
                border-radius: 25% / 10%;
                color: Crimson;
                text-align: center;
            }
            #sidebar1header {
                padding: 10px;
                cursor: move;
                z-index: 10;
                color: #fff;
            }
            .selected_element {
                color: LimeGreen;
            }
            body {
                background-color: #222;
            }
        </style>
    </body>
</html>